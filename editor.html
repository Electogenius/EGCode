<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<script type="module" charset="utf-8">
		import EGCode from "./compiler.module.js"
    	window.EGCode = EGCode
  </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.1/codemirror.min.js" integrity="sha512-ZTpbCvmiv7Zt4rK0ltotRJVRaSBKFQHQTrwfs6DoYlBYzO1MA6Oz2WguC+LkV8pGiHraYLEpo7Paa+hoVbCfKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.1/codemirror.min.css" integrity="sha512-xIf9AdJauwKIVtrVRZ0i4nHP61Ogx9fSRAkCLecmE2dL/U8ioWpDvFCAy4dcfecN72HHB9+7FfQj3aiO68aaaw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.1/theme/nord.min.css" integrity="sha512-sPc4jmw78pt6HyMiyrEt3QgURcNRk091l3dZ9M309x4wM2QwnCI7bUtsLnnWXqwBMECE5YZTqV6qCDwmC2FMVA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.1/addon/edit/closebrackets.min.js" integrity="sha512-cCnOU69ESswPmMV3f9TR7WgctoJZliqGbJ8WeLn0VlUrngSsmtVopRf6OG/epbURGfNmY4RY6RzZ/mWkPQ/onw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.1/addon/hint/show-hint.min.js" integrity="sha512-vmnoZMgVSaDE+VzynH2agDhizzixaoa27PqRWpqYXn4XOG/qxB/AFZOaRT/GIUbmVE1Fc/T1HGNiy/whbPz8uQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.1/addon/hint/show-hint.min.css" integrity="sha512-OmcLQEy8iGiD7PSm85s06dnR7G7C9C0VqahIPAj/KHk5RpOCmnC6R2ob1oK4/uwYhWa9BF1GC6tzxsC8TIx7Jg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/rainbow/1.2.0/js/rainbow.min.js" integrity="sha512-1iwOtzgGTn5KiNhyTHdGh8IpixXZnsD0vRXUqNUgWqET4Uv3vDXuHq55cGjdJ+qNBL/HxH815N7qvLxgzA1dYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<style type="text/css" media="all">
		body {
			background-color: black;
			color: white;
			font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif
		}
		
		#cm{
			border-radius: 5px !important;
		}

		#ov {
			position: absolute;
			z-index: 1;
			padding-left: 33px;
			/*background-color: black;*/
			font-family: monospace;
			padding-top: 4px;
			margin: 0;
		}

		div.CodeMirror-code[contenteditable="true"][role="presentation"]>div {
			opacity: 1;
			color: rgba(0, 0, 0, 0);
		}

		.function {
			color: #28e
		}

		.basic-string {
			color: #af3
		}

		.basic-number {
			color: #faa
		}

		.math {
			color: #d55
		}

		.bracket {
			color: gray;
		}
		.CodeMirror-hints{
			background-color: black;
			border: 1px solid white;
			color: white;
		}
		.CodeMirror-hint{
			border-bottom: 1px solid white;
			color: white;
		}
		
		#run{
			position: absolute;
			background-color: rgba(0, 0, 0, 0.5));
			color: white;
			padding: 10px;
			font-size: 1.5rem;
			margin-left: 50vw;
			border-radius: 5px;
			transform: translate(-50%, -50%);
			backdrop-filter: blur(5px);
			-webkit-backdrop-filter: blur(5px);
			z-index: 5;
		}
	</style>
</head>

<body>
	<pre id="ov"></pre>
	<div id="cm"></div>
	<span id="run">run</span>
	<script type="text/javascript" charset="utf-8">
		Rainbow.extend("egcode", [
			{
				name: "function",
				pattern: /^[\t ]*((?=\])|)[^\(\n ]+((?=\(.*\))|(?= ))/gm
	},
			{
				name: "math",
				pattern: /\(\[.*\]\)(?=$|\{|\[$)/gm
	},
			{
				name: "basic-number",
				pattern: /(\(\d*\)(?=$|\{|\[$))/gm
	},
			{
				name: "basic-string",
				pattern: /(\([^\[]?.*[^\]]?\)(?=$|\{|\[$))/gm
	},
			{
				name: "bracket",
				pattern: /(\{$|^[\t ]*\}|\[$|^[\t ]*\])/gm,
	}
	])
		try {
			var cm = new CodeMirror(document.getElementById("cm"), {
				value: "if([hello])[\n	log(2)\n]",
				theme: "nord",
				lineNumbers: true,
				autoCloseBrackets: true,
				mode: "EGCode",
				fontSize: 20
			})
		} catch (e) { console.log(e) }
		let sn = {}
		let w = ["log", "var ", "if", "repeat", "else", "elseif", "ifnt", "elseifnt","_log","sin","cos","ask","with_ {","sqrt","lengthof","rand","run","eval","max","min","not","give"].sort()
		try {
			
			sn = CodeMirror.hint.fromList(cm, {
				words: w
			})
		} catch (e) { console.log(e) }
		console.log(sn)
		cm.on("change", function(c,change) {
			highlight()
			let invalid = false;
			["{","}","(",")","[","]"].forEach(item=>{
				if(cm.getLine(cm.getCursor().line).trim().slice(0, cm.getCursor().ch).endsWith(item))invalid=true
			})
			if(!invalid && change.origin!="+delete"){
			try {
				CodeMirror.showHint(cm, (a, b) => {
					/*let e = {}
					e.to = (cm.getCursor())
					e.from = e.to
					e.from.ch-=cm.getLine(cm.getCursor().line).trim().slice(0,cm.getCursor().ch).length
					console.log(e.from)
					//console.log(cm.getLine(cm.getCursor().line).trim().slice(0,cm.getCursor().ch))
					e.list = sn.list.filter(it => {
						let t = cm.getLine(cm.getCursor().line).trim().slice(0, cm.getCursor().ch)
						
						//return Math.round(Math.random())
						return it.indexOf(t)===0
					})
					let dd = (e.list.length > 0) ? e : {
						to:e.to,
						from:e.from,
						list:w
					}
					sn.list=w
					return dd*/
					///*
					const cursor = cm.getCursor()
      const token = cm.getTokenAt(cursor)
      //console.log(token)
      const start = /*token.start*/token.string.match(/$ +/g)[0].length
      const end = cursor.ch
      const line = cursor.line
      const currentWord = token.string

      const list = w.filter(function (item) {
        return item.indexOf(currentWord) == 0
      })

      return {
        list: list.length ? list : w,
        from: CodeMirror.Pos(line, start),
        to: CodeMirror.Pos(line, end)
      }
					//*/
				}, { completeSingle: false })
				//console.log(document.getElementById("cm"))
			} catch (e) { console.log(e) }
		//	console.log(document.body.innerHTML.replace(/>/g,">\n"))
			}
		})

		function highlight() {
			Rainbow.color(cm.getValue(), "egcode", function(code) {
				document.getElementById("ov").innerHTML = code.replace(/\n/g, "<br>").replace(/\t/g, "    ")
				//console.log(code)
			})
		}
		highlight()
	</script>
</body>

</html>